\chapter{Implementation}
\label{cha:implementation}

The source code of this thesis prototype is available on GitLab and can be accessed under the following link: \verb|https://gitlab.com/Lisztos/mastodon|. It was implemented using two different Mastodon instances. The first one was a Linux server with Ubuntu 20.04, 2 CPU cores,  4GB RAM, and 80 GB storage capacity provided by the cloud provider Linode\footnote{https://linode.com}. The TU Berlin provided the second one, which was mainly used for debugging requests and testing the resolving processes in federated communication. Both domains used for the servers are \emph{lisztos.com} and \emph{tawki.snet.tu-berlin.de}. Amazon Simple Email Service (SES) was selected as the email delivery service, and Amazon S3 was used for storing the profile images of the servers. 

\section{Mastodon}

The source code\footnote{https://github.com/mastodon/mastodon} of Mastodon is open source and accessible for everyone to download. The core backend was implemented using the Model-View-Controller framework Ruby on Rails\footnote{https://rubyonrails.org/}, based on the Ruby programming language. The backend manages a Postgres\footnote{https://www.postgresql.org/} database, implements the ActivityPub server, provides a REST API for the frontend, and serves some web pages. The frontend of Mastodon was complemented using the React\footnote{https://reactjs.org} framework, which manages most of the dynamic parts of the interface. Finally, Nginx serves as the reverse proxy for the Mastodon instance.  
Mastodon provides a docker-compose configuration file to facilitate the deployment process. However, it was extended with the DID resolver services for the prototype. The services inside the extended docker-compose file are described in table \ref{table:mastodon_service}.

\begin{table}[H]
  \centering
  \begin{tabular}{|p{4cm}|p{10cm}| }
    \hline
    Service name & Description \\
    \hline
    \hline
    Web & Mastodon Rails application \\
    \hline
    DB & Postgres database \\
    \hline
    Redis & In-memory data store for caching and streaming \\
    \hline
    ElasticSearch (es) & Search engine for accounts or tags\\
    \hline
    Streaming & Mastodon's React application \\
    \hline
    Sidekiq & Tool to perform asynchronous processing\\
    \hline
    DID Resolver & Service to resolve DIDs \\
    \hline
    Uni-resolver-driver-did-uport & Driver for the did:ethr method\\
    \hline
  \end{tabular}
  \caption{Mastodon services}
  \label{table:mastodon_service}
\end{table}

\subsection{Requirements}

The requirements to run a mastodon server are:
\begin{itemize}
  \item Ubuntu 20.04 or Debian 11 for the operating system
  \item Domain name
  \item Email delivery service
  \item Object storage service (optionally)
\end{itemize}

Software requirements include: 
\begin{itemize}
  \item Nginx
  \item Docker
  \item Docker-Compose
\end{itemize}


\subsection{Configuration}

For external configuration, it is required that the domain name points to the IP address of the server. Furthermore, the accounts and providers for the Email delivery service or the object storage service must be set up in advance. 
Additionally, Nginx\footnote{https://nginx.com} is used to serve the Mastodon instance. Unfortunately, Nginx was not containerized and it must be manually configured. For complete instructions to configure Nginx see appendix \ref{appendix:nginx_configuration} 


\subsection{Build}

To build the source code of the prototype it is first required to add an \emph{env} file with the necessary environment variables for development to the root folder. An example file can be found in appendix \ref{appendix:env_file}, however, it is necessary to fill it up with the required credentials. Next, the image from the web service needs to be manually built with the following command. The \emph{-f} flag specifies to use the custom \emph{Dockerfile} and the \emph{-t} flag adds a name and tag to the image. 
  
\lstset{style=CodeStyle}
  \begin{lstlisting}[language=PHP, caption=Building the development Dockerfile, float=h]
    docker build -f Dockerfile.dev -t mastodon:dev .
  \end{lstlisting}


\subsection{Run}
After building the development image for the rails application, it is now possible to pull the images for the other services from the docker registry and get every container running using the commands shown in listing \ref{list:start_mastodon}.

\lstset{style=CodeStyle}
\begin{lstlisting}[language=PHP, caption=Starting all services of Mastodon, label=list:start_mastodon, float=ht]
  // Create and start containers
  docker-compose up -d

  // Restart NGINX
  sudo systemctl restart nginx

  // When everything is running, we need to run the migrations
  docker-compose exec web rails db:migrate
\end{lstlisting}


Visiting the provided domain using HTTPS will show the welcome page of Mastodon. In order to test the federated communication, this process should now be repeated using a different server. Having two different domain names was required for the prototype to test the whole DNS-based resolving process. However, the setup might also work using the raw IP address as the default domain. 


\section{DIDs}

In order to create a DID, the source code of the prototype includes a \emph{/veramo\_agent} folder with all the needed methods to perform CRUD operations to DIDs from the \emph{did:ethr} method. The setup was taken from Veramo's guides\footnote{https://veramo.io/docs/node\_tutorials/node\_setup\_identifiers/}, and the methods for the CRUD operations were written based on the API reference \footnote{https://veramo.io/docs/api/core}. 

\subsection{Requirements}

Software requirements to build the Veramo agent include: 
\begin{itemize}
  \item Node 10.8.2+
  \item Yarn
\end{itemize}

\subsection{Configuration}
First, an \emph{.env} file that contains the variable: \emph{INFURA\_PROJECT\_ID="example-infura-project-id"} from an Infura\footnote{https://infura.io/} account is required. This project ID has to match the Ethereum network desired. The default selected in the setup is \emph{Ropsten}.

\subsection{Build}
To build the project, the only command needed is \emph{yarn install} in the root of the \emph{/veramo\_agent} folder. 

\subsection{Run}
A set of \emph{scripts} are provided to facilitate the use of the CRUD methods. See table \ref{table:yarn_scripts} for a detailed view. However, to make any changes to a DID, it is first necessary to fund the Ethereum account to which the DID is anchored. This account can be found in the DID document, with the key \emph{blockchainAccountId} of the first verification method, as shown in listing \ref{fig:blockchain_id}. It follows the format  \emph{eip155:<network id>:<0x ethereum address>}. If the DID was created using a test network, the address can be funded using any Faucet\footnote{https://faucet.egorfine.com/}. Otherwise, Ether has to be transferred from a real account.
Finally, the prototype only supports parsing RSA keys from the DID document. To further understand how adding an RSA key works in Veramo, please refer to:\\
 \verb|https://gist.github.com/Lisztos/eade1f9199d46392f7c7d1f9bbfe7a3b|


\begin{table}[H]
  \centering
  \begin{tabular}{|p{4cm}|p{3cm}|p{7cm}| }
    \hline
    Command & Parameters & Description \\
    \hline
    \hline
    yarn id:create & & Creates a new DID \\
    \hline
    yarn id:list & & List the created identifiers by this agent \\
    \hline
    yarn id:resolve\_did & DID & Resolved the DID to its the DID document \\
    \hline
    yarn id:add\_service & DID,  Service \ref{fig:service_object} & Adds a new service to the DID document \\
    \hline
    yarn id:remove\_service & DID, Service ID & Removes the specified service\\
    \hline
    yarn id:add\_key & DID, Key & Adds a new key to the DID document. \\
    \hline
    yarn id:remove\_key & DID, Key ID & Removes the specified key\\
    \hline
  \end{tabular}
  \caption{CRUD operations for \emph{did:ethr} DIDs}
  \label{table:yarn_scripts}
\end{table}

\lstset{style=JSONStyle}
\begin{lstlisting}[language=PHP, caption=Controller address inside the DID document, label=fig:blockchain_id, float=h]
  {
  "@context": [
    "https://www.w3.org/ns/did/v1",
    "https://w3id.org/security/suites/secp256k1recovery-2020/v2"
  ],
  "id": "did:ethr:ropsten:0x031be462277...",
  "verificationMethod": [
    {
      "id": "did:ethr:ropsten:0x031be462277...#controller",
      "type": "EcdsaSecp256k1RecoveryMethod2020",
      "controller": "did:ethr:ropsten:0x031be462277...",
      "blockchainAccountId": "eip155:3:0x577361D41748c83ab328E90a51054712Fe49e211"  // Ethereum Address
    },
  ],
  {...}
}
\end{lstlisting}

\lstset{style=JSONStyle}
\begin{lstlisting}[language=PHP, caption=Parameters to add a service in Veramo, label=fig:service_object, float=h]
  const service= {
    did: <DID>,
    service: {
      id: 'ActivityPub', // This field will be overwritten
      type: "ActivityPub",
      serviceEndpoint: "http://your-domain.com/users/" + <DID>,
      description: "DIDComm enabled ActivityPub Actor"
    },
    options: {
      gas: 100_000, // between 40-60000
      ttl: 60 * 60 * 24 * 365 * 10 // make the service valid for ~10 years
    }
  }
\end{lstlisting}





